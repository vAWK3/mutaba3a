const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-C9T1eVUk.js","./vendor-router-D4Yqsbqz.js","./vendor-react-BdxwsYZ-.js","./vendor-query-CI0tl4qS.js","./vendor-db-BMy7eggi.js","./vendor-forms-CPtPuEGg.js","./index-ZzJlegSC.css"])))=>i.map(i=>d[i]);
import{r as c,j as e,a as J,L as O}from"./vendor-router-D4Yqsbqz.js";import{u as T,O as x,P as X,H as V,Q as Y,R as G,V as ee,W as M,X as U,Y as P,_ as q,Z as se,$ as te,d as ne,a0 as ae,a1 as ie,a2 as re,a3 as le,a as ce,T as Q}from"./index-C9T1eVUk.js";import{u as K}from"./vendor-query-CI0tl4qS.js";import"./vendor-react-BdxwsYZ-.js";import"./vendor-db-BMy7eggi.js";import"./vendor-forms-CPtPuEGg.js";function B(i,u){const r=u.join(","),s=i.map(g=>u.map(f=>{const o=g[f];if(o==null)return"";const d=String(o);return d.includes(",")||d.includes('"')||d.includes(`
`)||d.includes("\r")?`"${d.replace(/"/g,'""')}"`:d}).join(","));return[r,...s].join(`
`)}function F(i,u,r="text/csv;charset=utf-8"){const s=r.includes("csv")?"\uFEFF":"",g=new Blob([s+u],{type:r}),f=URL.createObjectURL(g),o=document.createElement("a");o.href=f,o.download=i,o.click(),URL.revokeObjectURL(f)}const oe=["id","name","email","phone","notes","createdAt","updatedAt","archivedAt"],de=["id","name","clientId","field","notes","createdAt","updatedAt","archivedAt"],me=["id","kind","status","title","clientId","projectId","categoryId","amountMinor","currency","occurredAt","dueDate","paidAt","notes","createdAt","updatedAt","deletedAt"];function ue({onClose:i,onSuccess:u}){const r=T(),s=K(),g=c.useRef(null),[f,o]=c.useState("idle"),[d,y]=c.useState(!1),[t,l]=c.useState("idle");c.useEffect(()=>{function h(N){N.key==="Escape"&&i()}return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[i]),c.useEffect(()=>{const h=g.current;h&&h.focus()},[]);const S=async()=>{o("exporting");try{const h=await x.clients.toArray(),N=await x.projects.toArray(),I=await x.transactions.toArray(),w=new Date().toISOString().split("T")[0];F(`clients-${w}.csv`,B(h,[...oe])),F(`projects-${w}.csv`,B(N,[...de])),F(`transactions-${w}.csv`,B(I,[...me])),o("done")}catch(h){o("error"),console.error("Export failed:",h)}},_=async()=>{l("deleting");try{await X(),s.invalidateQueries({queryKey:["transactions"]}),s.invalidateQueries({queryKey:["clients"]}),s.invalidateQueries({queryKey:["projects"]}),s.invalidateQueries({queryKey:["categories"]}),s.invalidateQueries({queryKey:["overviewTotals"]}),s.invalidateQueries({queryKey:["attentionReceivables"]}),s.invalidateQueries({queryKey:["clientSummaries"]}),s.invalidateQueries({queryKey:["projectSummaries"]}),u()}catch(h){l("error"),console.error("Delete failed:",h)}},v=f==="done"&&d&&t!=="deleting";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"modal-overlay",onClick:i}),e.jsxs("div",{className:"modal",role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",ref:g,tabIndex:-1,children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{id:"modal-title",className:"modal-title",children:r("settings.data.deleteModal.title")}),e.jsx("button",{className:"modal-close",onClick:i,"aria-label":"Close",children:e.jsx(he,{})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"modal-warning",children:[e.jsx(pe,{}),e.jsx("p",{children:r("settings.data.deleteModal.warning")})]}),e.jsxs("div",{className:"modal-step",children:[e.jsx("h3",{className:"modal-step-title",children:r("settings.data.deleteModal.stepA.title")}),e.jsx("p",{className:"modal-step-desc",children:r("settings.data.deleteModal.stepA.desc")}),e.jsxs("div",{className:"modal-step-action",children:[e.jsx("button",{className:"btn btn-primary",onClick:S,disabled:f==="exporting"||f==="done",children:r(f==="exporting"?"settings.data.deleteModal.stepA.exporting":"settings.data.deleteModal.stepA.btn")}),f==="done"&&e.jsxs("span",{className:"status-success",children:[e.jsx(xe,{})," ",r("settings.data.deleteModal.stepA.done")]}),f==="error"&&e.jsx("span",{className:"status-error",children:r("settings.data.deleteModal.stepA.error")})]})]}),e.jsxs("div",{className:`modal-step ${f!=="done"?"modal-step-disabled":""}`,children:[e.jsx("h3",{className:"modal-step-title",children:r("settings.data.deleteModal.stepB.title")}),e.jsxs("label",{className:"modal-checkbox",children:[e.jsx("input",{type:"checkbox",checked:d,onChange:h=>y(h.target.checked),disabled:f!=="done"}),e.jsx("span",{children:r("settings.data.deleteModal.stepB.checkbox")})]}),e.jsxs("div",{className:"modal-step-action",children:[e.jsx("button",{className:"btn btn-danger",onClick:_,disabled:!v,children:r(t==="deleting"?"settings.data.deleteModal.stepB.deleting":"settings.data.deleteModal.stepB.btn")}),t==="error"&&e.jsx("span",{className:"status-error",children:r("settings.data.deleteModal.stepB.error")})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-secondary",onClick:i,children:r("common.cancel")})})]})]})}function he(){return e.jsx("svg",{width:"20",height:"20",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18 18 6M6 6l12 12"})})}function pe(){return e.jsx("svg",{width:"24",height:"24",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}function xe(){return e.jsx("svg",{width:"16",height:"16",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})}function ge({onClose:i}){const u=T(),r=c.useRef(null),{data:s=[]}=V(),[g,f]=c.useState(null),[o,d]=c.useState("idle");c.useEffect(()=>{function l(S){S.key==="Escape"&&i()}return document.addEventListener("keydown",l),()=>document.removeEventListener("keydown",l)},[i]),c.useEffect(()=>{const l=r.current;l&&l.focus()},[]),c.useEffect(()=>{s.length===1&&!g&&f(s[0].id)},[s,g]);const y=async()=>{if(g){d("exporting");try{const l=await x.businessProfiles.get(g);if(!l)throw new Error("Profile not found");const S=await x.documents.filter(n=>n.businessProfileId===g&&!n.deletedAt).toArray(),_=await x.documentSequences.filter(n=>n.businessProfileId===g).toArray(),v=new Set,h=new Set;S.forEach(n=>{n.clientId&&v.add(n.clientId),n.linkedTransactionIds&&n.linkedTransactionIds.forEach(p=>h.add(p))});const N=await x.clients.filter(n=>v.has(n.id)&&!n.archivedAt).toArray(),I=await x.projects.filter(n=>!!n.clientId&&v.has(n.clientId)&&!n.archivedAt).toArray(),w=await x.transactions.filter(n=>h.has(n.id)&&!n.deletedAt).toArray(),m=await x.fxRates.toArray(),b={version:2,exportedAt:new Date().toISOString(),profileId:g,profile:l,documentSequences:_,documents:S,transactions:w,clients:N,projects:I,fxRates:m},A=JSON.stringify(b,null,2),C=new Blob([A],{type:"application/json"}),E=URL.createObjectURL(C),D=document.createElement("a");D.href=E;const R=(l.nameEn||l.name||"profile").replace(/[^a-zA-Z0-9]/g,"-");D.download=`mutaba3a-${R}-${new Date().toISOString().split("T")[0]}.json`,D.click(),URL.revokeObjectURL(E),d("done")}catch(l){d("error"),console.error("Export failed:",l)}}},t=s.find(l=>l.id===g);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"modal-overlay",onClick:i}),e.jsxs("div",{className:"modal",role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",ref:r,tabIndex:-1,children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{id:"modal-title",className:"modal-title",children:u("settings.data.export")}),e.jsx("button",{className:"modal-close",onClick:i,"aria-label":"Close",children:e.jsx(fe,{})})]}),e.jsx("div",{className:"modal-body",children:o==="done"?e.jsxs("div",{className:"export-success",children:[e.jsx(ve,{}),e.jsx("h3",{children:"Export Complete"}),e.jsx("p",{children:"Your data has been exported successfully."}),e.jsx("button",{className:"btn btn-primary",onClick:i,children:"Close"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-muted",style:{marginBottom:16},children:"Select a business profile to export. All documents, clients, projects, and transactions associated with this profile will be included."}),s.length===0?e.jsx("div",{className:"text-muted text-center",style:{padding:"24px 0"},children:"No business profiles found. Create a profile first."}):e.jsx("div",{className:"profile-select-list",children:s.map(l=>e.jsx(je,{profile:l,selected:g===l.id,onSelect:()=>f(l.id)},l.id))}),o==="error"&&e.jsx("div",{className:"status-error",style:{marginTop:12},children:"Export failed. Please try again."})]})}),o!=="done"&&e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:i,children:u("common.cancel")}),e.jsx("button",{className:"btn btn-primary",onClick:y,disabled:!g||o==="exporting",children:o==="exporting"?"Exporting...":`Export ${t?.name||"Profile"}`})]})]})]})}function je({profile:i,selected:u,onSelect:r}){return e.jsxs("button",{className:`profile-select-item ${u?"profile-select-item--selected":""}`,onClick:r,type:"button",children:[e.jsx("div",{className:"profile-select-item__radio",children:e.jsx("div",{className:`profile-select-item__radio-dot ${u?"profile-select-item__radio-dot--selected":""}`})}),e.jsxs("div",{className:"profile-select-item__info",children:[i.logoDataUrl&&e.jsx("img",{src:i.logoDataUrl,alt:"",className:"profile-select-item__logo"}),e.jsxs("div",{className:"profile-select-item__details",children:[e.jsxs("div",{className:"profile-select-item__name",children:[i.name,i.nameEn&&e.jsxs("span",{className:"text-muted",children:[" (",i.nameEn,")"]})]}),e.jsxs("div",{className:"profile-select-item__meta text-muted text-sm",children:[i.email,i.isDefault&&e.jsx("span",{className:"badge badge-primary",style:{marginInlineStart:8},children:"Default"})]})]})]})]})}function fe(){return e.jsx("svg",{width:"20",height:"20",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18 18 6M6 6l12 12"})})}function ve(){return e.jsx("svg",{width:"48",height:"48",fill:"none",viewBox:"0 0 24 24",stroke:"var(--color-success)",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})})}function ye({onClose:i,onSuccess:u}){const r=T(),s=K(),g=c.useRef(null),f=c.useRef(null),{data:o=[]}=V(),[d,y]=c.useState("select"),[t,l]=c.useState(null),[S,_]=c.useState(""),[v,h]=c.useState("create"),[N,I]=c.useState(null),[w,m]=c.useState(""),[b,A]=c.useState(null);c.useEffect(()=>{function n(p){p.key==="Escape"&&i()}return document.addEventListener("keydown",n),()=>document.removeEventListener("keydown",n)},[i]),c.useEffect(()=>{const n=g.current;n&&n.focus()},[]);const C=c.useCallback(async n=>{try{const p=await n.text(),a=JSON.parse(p);if(_(n.name),l(a),a.version===2&&a.profile){const j=o.find(k=>k.id===a.profileId||k.email===a.profile?.email);j?(I(j.id),h("merge")):h("create")}else h("legacy");y("preview"),m("")}catch(p){m("Failed to read file. Please select a valid JSON file."),console.error("File read error:",p)}},[o]),E=c.useCallback(n=>{n.preventDefault();const p=n.dataTransfer.files[0];p&&p.name.endsWith(".json")?C(p):m("Please drop a .json file")},[C]),D=async()=>{if(t){y("importing"),m("");try{let n={profiles:0,documents:0,transactions:0};if(v==="legacy")await Y(),t.clients?.length&&await x.clients.bulkAdd(t.clients),t.projects?.length&&await x.projects.bulkAdd(t.projects),t.categories?.length&&await x.categories.bulkAdd(t.categories),t.transactions?.length&&(await x.transactions.bulkAdd(t.transactions),n.transactions=t.transactions.length),t.fxRates?.length&&await x.fxRates.bulkAdd(t.fxRates),t.settings?.length&&await x.settings.bulkAdd(t.settings);else if(v==="create"&&t.profile){const p=crypto.randomUUID(),a={...t.profile,id:p,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isDefault:o.length===0};if(await x.businessProfiles.add(a),n.profiles=1,t.documents?.length){const j=t.documents.map(k=>({...k,id:crypto.randomUUID(),businessProfileId:p}));await x.documents.bulkAdd(j),n.documents=j.length}if(t.documentSequences?.length){const j=t.documentSequences.map(k=>({...k,id:`${p}:${k.documentType}`,businessProfileId:p}));await x.documentSequences.bulkAdd(j)}if(t.clients?.length)for(const j of t.clients)j.email&&await x.clients.where("email").equals(j.email).first()||await x.clients.add({...j,id:crypto.randomUUID()});if(t.projects?.length)for(const j of t.projects)await x.projects.where("name").equals(j.name).first()||await x.projects.add({...j,id:crypto.randomUUID()});if(t.transactions?.length){const j=t.transactions.map(k=>({...k,id:crypto.randomUUID()}));await x.transactions.bulkAdd(j),n.transactions=j.length}if(t.fxRates?.length)for(const j of t.fxRates)try{await x.fxRates.add({...j,id:crypto.randomUUID()})}catch{}}else if(v==="merge"&&N){if(t.profile){const{id:p,createdAt:a,...j}=t.profile;await x.businessProfiles.update(N,{...j,updatedAt:new Date().toISOString()}),n.profiles=1}if(t.documents?.length){const p=t.documents.map(a=>({...a,id:crypto.randomUUID(),businessProfileId:N}));await x.documents.bulkAdd(p),n.documents=p.length}if(t.transactions?.length){const p=t.transactions.map(a=>({...a,id:crypto.randomUUID()}));await x.transactions.bulkAdd(p),n.transactions=p.length}}s.invalidateQueries(),A(n),y("done"),u&&u()}catch(n){m(n instanceof Error?n.message:"Import failed"),y("error"),console.error("Import error:",n)}}},L=t?.version===2&&t?.profile,R=t?.profile?.name||t?.profile?.nameEn||"Unknown";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"modal-overlay",onClick:i}),e.jsxs("div",{className:"modal",role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",ref:g,tabIndex:-1,style:{maxWidth:520},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{id:"modal-title",className:"modal-title",children:r("settings.data.import")}),e.jsx("button",{className:"modal-close",onClick:i,"aria-label":"Close",children:e.jsx(Ne,{})})]}),e.jsxs("div",{className:"modal-body",children:[d==="select"&&e.jsxs("div",{className:"import-dropzone",onDrop:E,onDragOver:n=>n.preventDefault(),onClick:()=>f.current?.click(),children:[e.jsx(be,{}),e.jsx("p",{children:"Drop a .json file here or click to select"}),e.jsx("input",{ref:f,type:"file",accept:".json",style:{display:"none"},onChange:n=>{const p=n.target.files?.[0];p&&C(p)}}),w&&e.jsx("p",{className:"text-danger text-sm",children:w})]}),d==="preview"&&t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"import-file-info",children:[e.jsx(we,{}),e.jsxs("div",{children:[e.jsx("div",{className:"import-file-name",children:S}),e.jsxs("div",{className:"import-file-meta text-muted text-sm",children:[L?e.jsxs(e.Fragment,{children:["Profile: ",R]}):e.jsx(e.Fragment,{children:"Legacy format (all data)"}),t.exportedAt&&e.jsxs(e.Fragment,{children:[" · Exported: ",new Date(t.exportedAt).toLocaleDateString()]})]})]})]}),L&&e.jsxs("div",{className:"import-mode-select",children:[e.jsx("h4",{children:"Import Options"}),e.jsxs("label",{className:"import-mode-option",children:[e.jsx("input",{type:"radio",name:"importMode",checked:v==="create",onChange:()=>h("create")}),e.jsxs("div",{children:[e.jsx("div",{className:"import-mode-label",children:"Create new profile"}),e.jsx("div",{className:"import-mode-desc text-muted text-sm",children:"Import as a new business profile with a new ID"})]})]}),o.length>0&&e.jsxs("label",{className:"import-mode-option",children:[e.jsx("input",{type:"radio",name:"importMode",checked:v==="merge",onChange:()=>h("merge")}),e.jsxs("div",{children:[e.jsx("div",{className:"import-mode-label",children:"Merge into existing profile"}),e.jsx("div",{className:"import-mode-desc text-muted text-sm",children:"Add documents and transactions to an existing profile"})]})]}),v==="merge"&&e.jsx("div",{className:"import-profile-select",children:e.jsxs("select",{className:"select",value:N||"",onChange:n=>I(n.target.value),children:[e.jsx("option",{value:"",children:"Select a profile..."}),o.map(n=>e.jsxs("option",{value:n.id,children:[n.name," ",n.nameEn&&`(${n.nameEn})`]},n.id))]})})]}),!L&&e.jsxs("div",{className:"modal-warning",children:[e.jsx(ke,{}),e.jsx("p",{children:"This is a legacy backup file. Importing will replace all existing data."})]}),w&&e.jsx("p",{className:"text-danger text-sm",children:w})]}),d==="importing"&&e.jsxs("div",{className:"import-progress",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Importing data..."})]}),d==="done"&&e.jsxs("div",{className:"export-success",children:[e.jsx(Se,{}),e.jsx("h3",{children:"Import Complete"}),e.jsx("p",{children:b&&e.jsxs(e.Fragment,{children:["Imported ",b.profiles>0&&`${b.profiles} profile, `,b.documents>0&&`${b.documents} documents, `,b.transactions>0&&`${b.transactions} transactions`]})}),e.jsx("button",{className:"btn btn-primary",onClick:i,children:"Close"})]}),d==="error"&&e.jsxs("div",{className:"import-error",children:[e.jsx(_e,{}),e.jsx("h3",{children:"Import Failed"}),e.jsx("p",{className:"text-danger",children:w}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>y("select"),children:"Try Again"})]})]}),(d==="select"||d==="preview")&&e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:i,children:r("common.cancel")}),d==="preview"&&e.jsx("button",{className:"btn btn-primary",onClick:D,disabled:v==="merge"&&!N,children:"Import"})]})]})]})}function Ne(){return e.jsx("svg",{width:"20",height:"20",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18 18 6M6 6l12 12"})})}function be(){return e.jsx("svg",{width:"48",height:"48",fill:"none",viewBox:"0 0 24 24",stroke:"var(--color-muted)",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"})})}function we(){return e.jsx("svg",{width:"24",height:"24",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"})})}function ke(){return e.jsx("svg",{width:"24",height:"24",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}function Se(){return e.jsx("svg",{width:"48",height:"48",fill:"none",viewBox:"0 0 24 24",stroke:"var(--color-success)",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})})}function _e(){return e.jsx("svg",{width:"48",height:"48",fill:"none",viewBox:"0 0 24 24",stroke:"var(--color-error)",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"})})}const $=typeof window<"u"&&"__TAURI_INTERNALS__"in window;function Ie(){const{status:i,pendingConflicts:u,lastSyncAt:r,serverRunning:s}=G(),{openExportModal:g,openImportModal:f,openPairingModal:o,startDiscovery:d,refreshCounts:y}=ee(),t=M(m=>m.trustedPeers),l=M(m=>m.pendingOpsCount),S=M(m=>m.discoveredPeers),_=M(m=>m.isDiscovering),[v,h]=c.useState(!1);c.useEffect(()=>{y()},[]);const N=async()=>{if($){h(!0);try{const{invoke:m}=await q(async()=>{const{invoke:C}=await import("./core-BEOw45JP.js");return{invoke:C}},[],import.meta.url),b=await Ce(),A=await m("start_sync_server",{deviceId:b.id,deviceName:b.name,autoShutdownMinutes:30});M.getState().setServerRunning(!0,A.port,A.expires_at??void 0)}catch(m){console.error("Failed to start sync server:",m)}finally{h(!1)}}},I=async()=>{if($)try{const{invoke:m}=await q(async()=>{const{invoke:b}=await import("./core-BEOw45JP.js");return{invoke:b}},[],import.meta.url);await m("stop_sync_server"),M.getState().setServerRunning(!1)}catch(m){console.error("Failed to stop sync server:",m)}},w=()=>{d()};return e.jsxs("div",{className:"sync-section",children:[e.jsx("h2",{className:"sync-section__title",children:"Sync"}),e.jsx(U,{className:"sync-section__card",children:e.jsxs("div",{className:"sync-status-block",children:[e.jsxs("div",{className:"sync-status-block__header",children:[e.jsx("span",{className:`sync-status-indicator sync-status-indicator--${i}`}),e.jsx("span",{className:"sync-status-block__title",children:Ae(i,u)})]}),e.jsxs("div",{className:"sync-status-block__meta",children:[r&&e.jsxs("div",{className:"sync-meta-item",children:[e.jsx("span",{className:"sync-meta-item__label",children:"Last sync:"}),e.jsx("span",{className:"sync-meta-item__value",children:De(r)})]}),l>0&&e.jsxs("div",{className:"sync-meta-item",children:[e.jsx("span",{className:"sync-meta-item__label",children:"Pending changes:"}),e.jsx("span",{className:"sync-meta-item__value",children:l})]}),t.length>0&&e.jsxs("div",{className:"sync-meta-item",children:[e.jsx("span",{className:"sync-meta-item__label",children:"Trusted devices:"}),e.jsx("span",{className:"sync-meta-item__value",children:t.map(m=>m.name).join(", ")})]})]})]})}),$&&e.jsxs(U,{className:"sync-section__card",children:[e.jsx("h3",{className:"sync-section__subtitle",children:"Wi-Fi Sync"}),e.jsxs("div",{className:"sync-server-toggle",children:[e.jsxs("div",{className:"sync-server-toggle__info",children:[e.jsx("span",{className:"sync-server-toggle__label",children:"Make this desktop available for sync"}),e.jsx("span",{className:"sync-server-toggle__helper",children:s?"This desktop is discoverable on your network.":"Your phone won't find this desktop on Wi-Fi."})]}),e.jsx(P,{variant:s?"secondary":"primary",onClick:s?I:N,disabled:v,children:v?"Starting...":s?"Stop Server":"Start Server"})]}),s&&e.jsxs("div",{className:"sync-discovery",children:[e.jsxs("div",{className:"sync-discovery__actions",children:[e.jsx(P,{variant:"primary",onClick:o,children:"Pair Device"}),e.jsx(P,{variant:"ghost",onClick:w,disabled:_,children:_?"Discovering...":"Find Devices"})]}),S.length>0&&e.jsx("ul",{className:"sync-discovered-list",children:S.map(m=>e.jsxs("li",{className:"sync-discovered-item",children:[e.jsx("span",{className:"sync-discovered-item__name",children:m.name}),e.jsxs("span",{className:"sync-discovered-item__address",children:[m.address,":",m.port]})]},m.deviceId))})]})]}),e.jsxs(U,{className:"sync-section__card",children:[e.jsx("h3",{className:"sync-section__subtitle",children:"Export / Import"}),e.jsx("p",{className:"sync-section__description",children:"Use this to sync when Wi-Fi sync isn't available. Creates an encrypted file with your changes."}),e.jsxs("div",{className:"sync-fallback-actions",children:[e.jsx(P,{variant:"secondary",onClick:g,children:"Export Sync Bundle"}),e.jsx(P,{variant:"secondary",onClick:f,children:"Import Sync Bundle"})]})]}),u>0&&e.jsxs(U,{className:"sync-section__card sync-section__card--warning",children:[e.jsx("h3",{className:"sync-section__subtitle",children:"Conflicts"}),e.jsxs("p",{className:"sync-section__description",children:[u," ",u===1?"edit needs":"edits need"," your review. These changes were made on multiple devices."]}),e.jsx(P,{variant:"primary",children:"Review Conflicts"})]})]})}async function Ce(){const{getOrCreateLocalDevice:i}=await q(async()=>{const{getOrCreateLocalDevice:u}=await import("./index-C9T1eVUk.js").then(r=>r.aO);return{getOrCreateLocalDevice:u}},__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url);return i()}function Ae(i,u){if(u>0)return"Conflicts need review";switch(i){case"syncing":return"Syncing...";case"error":return"Sync error";case"offline":return"Offline";default:return"Synced"}}function De(i){return new Date(i).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}const Z={mac:"/download/mac",windows:"/download/windows"},W="0.0.17";function Ee({profile:i,onEdit:u,onSetDefault:r,onArchive:s,isSetDefaultPending:g,isArchivePending:f}){const[o,d]=c.useState(!1),y=c.useRef(null);return c.useEffect(()=>{function t(l){y.current&&!y.current.contains(l.target)&&d(!1)}return o&&document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[o]),c.useEffect(()=>{function t(l){l.key==="Escape"&&d(!1)}return o&&document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[o]),e.jsxs("div",{className:"add-menu-container",ref:y,children:[e.jsx("button",{className:"btn btn-ghost btn-sm",onClick:()=>d(!o),children:e.jsx(Le,{})}),o&&e.jsxs("div",{className:"add-menu",children:[e.jsx("button",{className:"add-menu-item",onClick:()=>{u(),d(!1)},children:"Edit"}),!i.isDefault&&e.jsx("button",{className:"add-menu-item",onClick:()=>{r(),d(!1)},disabled:g,children:"Set as Default"}),!i.isDefault&&e.jsx("button",{className:"add-menu-item text-danger",onClick:()=>{confirm("Are you sure you want to archive this business profile?")&&(s(),d(!1))},disabled:f,children:"Archive"})]})]})}function Le(){return e.jsx("svg",{width:"16",height:"16",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"})})}function Be(){const{data:i,isLoading:u}=se(),r=te(),s=T(),g=J(),{language:f,setLanguage:o}=ne(),{theme:d,setTheme:y}=ae(),[t,l]=c.useState(!1),[S,_]=c.useState(!1),[v,h]=c.useState(!1),[N,I]=c.useState(""),{latestVersion:w,hasUpdate:m,isLoading:b,error:A}=ie(),{data:C=[]}=V(),E=re(),D=le(),{openBusinessProfileDrawer:L}=ce(),R=a=>{if(!i)return;const j=i.enabledCurrencies,k=j.includes(a);if(k&&j.length===1)return;const z=k?j.filter(H=>H!==a):[...j,a];r.mutate({enabledCurrencies:z})},n=a=>{r.mutate({defaultCurrency:a})},p=()=>{l(!1),I(s("settings.data.deleteModal.success")),setTimeout(()=>{I(""),g({to:"/"})},2e3)};return u?e.jsxs(e.Fragment,{children:[e.jsx(Q,{title:s("settings.title"),hideAddMenu:!0}),e.jsx("div",{className:"page-content",children:e.jsx("div",{className:"loading",children:e.jsx("div",{className:"spinner"})})})]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{title:s("settings.title"),hideAddMenu:!0}),e.jsxs("div",{className:"page-content",style:{maxWidth:600},children:[e.jsxs("div",{className:"settings-section",children:[e.jsx("h3",{className:"settings-section-title",children:s("settings.language.title")}),e.jsxs("div",{className:"settings-row",children:[e.jsx("div",{children:e.jsx("div",{className:"settings-label",children:s("settings.language.description")})}),e.jsx("div",{style:{display:"flex",gap:8},children:["en","ar"].map(a=>e.jsx("button",{className:`btn btn-sm ${f===a?"btn-primary":"btn-secondary"}`,onClick:()=>o(a),children:a==="en"?"English":"العربية"},a))})]})]}),e.jsxs("div",{className:"settings-section",children:[e.jsx("h3",{className:"settings-section-title",children:s("settings.theme.title")}),e.jsxs("div",{className:"settings-row",children:[e.jsx("div",{children:e.jsx("div",{className:"settings-label",children:s("settings.theme.description")})}),e.jsx("div",{style:{display:"flex",gap:8},children:["light","dark","system"].map(a=>e.jsx("button",{className:`btn btn-sm ${d===a?"btn-primary":"btn-secondary"}`,onClick:()=>y(a),children:s(`settings.theme.${a}`)},a))})]})]}),e.jsx("div",{className:"settings-section",children:e.jsx(Ie,{})}),e.jsxs("div",{className:"settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{className:"settings-section-title",children:"Business Profiles"}),e.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>L({mode:"create"}),children:"+ Add Profile"})]}),C.length===0?e.jsx("div",{className:"text-muted text-sm",children:"No business profiles yet. Create one to start issuing invoices."}):e.jsx("div",{className:"business-profiles-list",children:C.map(a=>e.jsxs("div",{className:"business-profile-item",children:[e.jsxs("div",{className:"business-profile-info",children:[a.logoDataUrl&&e.jsx("img",{src:a.logoDataUrl,alt:"",className:"business-profile-logo"}),e.jsxs("div",{className:"business-profile-details",children:[e.jsxs(O,{to:"/settings/profiles/$profileId",params:{profileId:a.id},className:"business-profile-name",style:{textDecoration:"none",color:"inherit"},children:[a.name,a.nameEn&&e.jsxs("span",{className:"text-muted",children:[" (",a.nameEn,")"]})]}),e.jsxs("div",{className:"business-profile-meta text-muted text-sm",children:[a.email,a.isDefault&&e.jsx("span",{className:"badge badge-primary",style:{marginInlineStart:8},children:"Default"})]})]})]}),e.jsx(Ee,{profile:a,onEdit:()=>g({to:"/settings/profiles/$profileId",params:{profileId:a.id}}),onSetDefault:()=>E.mutate(a.id),onArchive:()=>D.mutate(a.id),isSetDefaultPending:E.isPending,isArchivePending:D.isPending})]},a.id))})]}),e.jsxs("div",{className:"settings-section",children:[e.jsx("h3",{className:"settings-section-title",children:s("settings.currency.title")}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"settings-label",children:s("settings.currency.enabled")}),e.jsx("div",{className:"settings-description",children:s("settings.currency.enabledDesc")})]}),e.jsx("div",{style:{display:"flex",gap:8},children:["USD","ILS"].map(a=>e.jsx("button",{className:`btn btn-sm ${i?.enabledCurrencies.includes(a)?"btn-primary":"btn-secondary"}`,onClick:()=>R(a),children:a},a))})]}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"settings-label",children:s("settings.currency.default")}),e.jsx("div",{className:"settings-description",children:s("settings.currency.defaultDesc")})]}),e.jsx("select",{className:"select",value:i?.defaultCurrency,onChange:a=>n(a.target.value),children:i?.enabledCurrencies.map(a=>e.jsx("option",{value:a,children:a},a))})]})]}),e.jsxs("div",{className:"settings-section",children:[e.jsx("h3",{className:"settings-section-title",children:s("settings.data.title")}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"settings-label",children:s("settings.data.export")}),e.jsx("div",{className:"settings-description",children:s("settings.data.exportDesc")})]}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>_(!0),children:s("settings.data.exportBtn")})]}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"settings-label",children:s("settings.data.import")}),e.jsx("div",{className:"settings-description",children:s("settings.data.importDesc")})]}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>h(!0),children:s("settings.data.importBtn")})]}),e.jsxs("div",{className:"settings-row",style:{borderTop:"1px solid var(--color-border)",paddingTop:16,marginTop:8},children:[e.jsxs("div",{children:[e.jsx("div",{className:"settings-label text-danger",children:s("settings.data.deleteAll")}),e.jsx("div",{className:"settings-description",children:s("settings.data.deleteAllDesc")})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[N&&e.jsx("span",{className:"text-sm text-success",children:N}),e.jsx("button",{className:"btn btn-danger",onClick:()=>l(!0),children:s("settings.data.deleteAllBtn")})]})]})]}),e.jsxs("div",{className:"settings-section",children:[e.jsx("h3",{className:"settings-section-title",children:s("settings.about.title")}),e.jsxs("div",{className:"text-muted",children:[e.jsx("p",{children:s("settings.about.name")}),e.jsx("p",{className:"text-sm",style:{marginTop:8},children:s("settings.about.description")}),e.jsxs("p",{className:"text-sm",style:{marginTop:12},children:[s("settings.updates.currentVersion"),": ",e.jsx("span",{style:{fontFamily:"var(--font-mono)",fontWeight:500},children:W})]})]})]}),e.jsxs("div",{className:"settings-section",children:[e.jsx("h3",{className:"settings-section-title",children:s("settings.updates.title")}),b?e.jsx("div",{className:"text-muted",children:s("settings.updates.checking")}):A?e.jsx("div",{className:"text-muted",children:s("settings.updates.checkFailed")}):m?e.jsxs("div",{className:"update-banner",children:[e.jsxs("div",{className:"update-banner-content",children:[e.jsx("div",{className:"update-banner-title",children:s("settings.updates.updateAvailable")}),e.jsxs("div",{className:"update-banner-versions",children:[s("settings.updates.currentVersion"),": ",e.jsx("span",{className:"update-banner-version",children:W})," → ",s("settings.updates.latestVersion"),": ",e.jsx("span",{className:"update-banner-version",children:w})]})]}),e.jsx(O,{to:"/download",className:"btn btn-primary",children:s("settings.updates.updateNow")})]}):e.jsx("div",{className:"settings-row",children:e.jsxs("div",{children:[e.jsx("div",{className:"settings-label",children:s("settings.updates.upToDate")}),e.jsxs("div",{className:"settings-description",children:[s("settings.updates.currentVersion"),": ",e.jsx("span",{style:{fontFamily:"var(--font-mono)"},children:W})]})]})})]}),e.jsxs("div",{className:"settings-section",children:[e.jsx("h3",{className:"settings-section-title",children:s("settings.desktopApp.title")}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"settings-label",children:s("settings.desktopApp.download")}),e.jsx("div",{className:"settings-description",children:s("settings.desktopApp.downloadDesc")})]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("a",{href:Z.mac,className:"btn btn-secondary",rel:"noopener",children:s("settings.desktopApp.downloadMac")}),e.jsx("a",{href:Z.windows,className:"btn btn-secondary",rel:"noopener",children:s("settings.desktopApp.downloadWindows")})]})]}),e.jsxs("div",{className:"settings-row",children:[e.jsx("div",{children:e.jsx("div",{className:"settings-label",style:{color:"var(--color-text-muted)"},children:s("download.allVersions")})}),e.jsx(O,{to:"/download",className:"btn btn-ghost",children:s("settings.desktopApp.downloadBtn")})]})]})]}),S&&e.jsx(ge,{onClose:()=>_(!1)}),v&&e.jsx(ye,{onClose:()=>h(!1)}),t&&e.jsx(ue,{onClose:()=>l(!1),onSuccess:p})]})}export{Be as SettingsPage};
