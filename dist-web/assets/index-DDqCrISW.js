import{j as e,r as D,a as Q,f as ee}from"./vendor-router-D4Yqsbqz.js";import{V as C,u as k,p as A,d as O,aJ as R,a as H,aK as b,l as I,n as Y}from"./index-WOWG8CNN.js";import{b as B}from"./vendor-query-CI0tl4qS.js";import"./vendor-react-BdxwsYZ-.js";import"./vendor-db-BMy7eggi.js";import"./vendor-forms-Bf8hyTk9.js";function K(){return new Date().toISOString().split("T")[0]}function X(n){const[t,s]=n.split("-").map(Number),c=`${t}-${String(s).padStart(2,"0")}-01`,a=new Date(t,s,0).getDate(),d=`${t}-${String(s).padStart(2,"0")}-${String(a).padStart(2,"0")}`;return{start:c,end:d}}function ne(n){const{start:t,end:s}=X(n),c=[],a=new Date(t),d=new Date(s);for(;a<=d;)c.push(a.toISOString().split("T")[0]),a.setDate(a.getDate()+1);return c}function P(n,t){const s=new Date(n),a=new Date(t).getTime()-s.getTime();return Math.floor(a/(1e3*60*60*24))}function te(n,t){const s=K();let c,a,d,l="high";n.kind==="income"?(c="inflow",n.status==="paid"?(a="actual_income",d="paid"):(a="receivable",n.dueDate&&n.dueDate<s?d="overdue":d="unpaid")):(c="outflow",a="actual_cost",d="paid");let u=n.occurredAt.split("T")[0];return n.status==="paid"&&n.paidAt?u=n.paidAt.split("T")[0]:n.status==="unpaid"&&n.dueDate&&(u=n.dueDate),{id:`tx-${n.id}`,direction:c,source:a,state:d,amountMinor:n.amountMinor,currency:n.currency,eventDate:u,dueDate:n.dueDate,paidDate:n.paidAt?.split("T")[0],counterparty:n.clientId&&t?{id:n.clientId,name:t,type:"client"}:void 0,title:n.title||(n.kind==="income"?"Income":"Expense"),confidence:l,sourceEntityId:n.id,sourceEntityType:"transaction"}}function se(n,t){return{id:`exp-${n.id}`,profileId:n.profileId,direction:"outflow",source:"profile_expense",state:"paid",amountMinor:n.amountMinor,currency:n.currency,eventDate:n.occurredAt.split("T")[0],paidDate:n.occurredAt.split("T")[0],counterparty:t?{id:n.vendorId||"",name:t,type:"vendor"}:void 0,title:n.title||n.vendor||"Expense",confidence:"high",sourceEntityId:n.id,sourceEntityType:"expense"}}function ie(n,t,s){const c=K();let a,d;return n.state==="received"?(a="paid",d="high"):n.state==="partial"?(a="unpaid",d="high"):n.state==="due"?(a=n.expectedDate<c?"overdue":"unpaid",d="high"):n.state==="missed"?(a="missed",d="high"):n.state==="canceled"?(a="cancelled",d="high"):(a="upcoming",d="medium"),{id:`pi-${n.id}`,profileId:n.profileId,direction:"inflow",source:"retainer",state:a,amountMinor:n.expectedAmountMinor-n.receivedAmountMinor,currency:n.currency,eventDate:n.expectedDate,expectedDate:n.expectedDate,paidDate:n.receivedAt?.split("T")[0],counterparty:n.clientId&&t?{id:n.clientId,name:t,type:"client"}:void 0,title:s||"Retainer Payment",confidence:d,sourceEntityId:n.id,sourceEntityType:"projectedIncome"}}const U={async getMoneyEvents(n){const{month:t,currency:s,includeReceivables:c=!0,includeProjections:a=!0}=n;if(!t)throw new Error("Month is required for money events");const{start:d,end:l}=X(t),u=[],v=await C.clients.toArray(),h=new Map(v.map(r=>[r.id,r.name])),x=await C.vendors.toArray(),m=new Map(x.map(r=>[r.id,r.canonicalName])),w=await C.retainerAgreements.toArray(),i=new Map(w.map(r=>[r.id,r.title])),y=await C.transactions.filter(r=>{if(r.deletedAt||r.currency!==s)return!1;let p;return r.kind==="income"&&r.status==="paid"&&r.paidAt?p=r.paidAt.split("T")[0]:r.kind==="income"&&r.status==="unpaid"&&r.dueDate?p=r.dueDate:p=r.occurredAt.split("T")[0],!(p<d||p>l||!c&&r.kind==="income"&&r.status==="unpaid")}).toArray();for(const r of y)u.push(te(r,r.clientId?h.get(r.clientId):void 0));const g=await C.expenses.filter(r=>{if(r.deletedAt||r.currency!==s)return!1;const p=r.occurredAt.split("T")[0];return p>=d&&p<=l}).toArray();for(const r of g)u.push(se(r,r.vendorId?m.get(r.vendorId):r.vendor));if(a){const r=await C.projectedIncome.filter(p=>p.currency!==s||p.state==="canceled"?!1:p.expectedDate>=d&&p.expectedDate<=l).toArray();for(const p of r)p.state==="received"&&p.receivedAmountMinor>=p.expectedAmountMinor||u.push(ie(p,p.clientId?h.get(p.clientId):void 0,p.sourceId?i.get(p.sourceId):void 0))}return u.sort((r,p)=>r.eventDate.localeCompare(p.eventDate)),u},async getDailyAggregates(n,t=0){if(!n.month)throw new Error("Month is required for daily aggregates");const s=await this.getMoneyEvents(n),c=ne(n.month),a=new Map;for(const u of s){const v=a.get(u.eventDate)||[];v.push(u),a.set(u.eventDate,v)}let d=t;const l=[];for(const u of c){const v=a.get(u)||[];let h=0,x=0,m="high";for(const i of v)i.direction==="inflow"?i.state==="paid"&&(h+=i.amountMinor):x+=i.amountMinor,i.confidence==="low"?m="low":i.confidence==="medium"&&m==="high"&&(m="medium");const w=h-x;d+=w,l.push({date:u,inflowMinor:h,outflowMinor:x,netMinor:w,runningBalanceMinor:d,events:v,confidenceLevel:m})}return l},async getMonthSummary(n){if(!n.month)throw new Error("Month is required for month summary");const t=await this.getMoneyEvents(n);let s=0,c=0,a=0,d=0;for(const l of t)l.direction==="inflow"?l.state==="paid"?s+=l.amountMinor:(l.state==="unpaid"||l.state==="overdue"||l.state==="upcoming")&&(a+=l.amountMinor):l.state==="paid"?c+=l.amountMinor:l.state==="upcoming"&&(d+=l.amountMinor);return{month:n.month,totalInflowMinor:s,totalOutflowMinor:c,netMinor:s-c,awaitingMinor:a,projectedOutflowMinor:d}},async generateGuidance(n){const t=K(),s=await this.getMoneyEvents(n),c=[],a=await this.getMonthSummary(n),d=a.totalInflowMinor>0?a.totalInflowMinor:1e5,l=s.filter(i=>i.direction==="inflow"&&i.state==="overdue"&&i.dueDate&&P(i.dueDate,t)>30);if(l.length>0){const i=l.reduce((y,g)=>y+g.amountMinor,0);c.push({id:"overdue-30-days",severity:"critical",category:"collect",title:`${l.length} payment${l.length>1?"s":""} overdue 30+ days`,description:"These receivables are significantly overdue. Consider following up urgently.",impactMinor:i,impactCurrency:n.currency,relatedEventIds:l.map(y=>y.id),primaryAction:{label:"View Details",type:"viewReceivables"}})}const u=s.filter(i=>i.direction==="inflow"&&i.state==="overdue"&&i.amountMinor>d*.2);for(const i of u)l.some(y=>y.id===i.id&&P(y.dueDate,t)>30)||c.push({id:`large-overdue-${i.id}`,severity:"critical",category:"collect",title:`Large overdue: ${i.title}`,description:"This overdue amount represents a significant portion of your monthly income.",impactMinor:i.amountMinor,impactCurrency:n.currency,relatedEventIds:[i.id],primaryAction:{label:"Mark Paid",type:"markPaid",payload:{eventId:i.sourceEntityId}}});const v=s.filter(i=>i.direction==="inflow"&&i.state==="unpaid"&&i.dueDate&&P(t,i.dueDate)>=0&&P(t,i.dueDate)<=7);if(v.length>0){const i=v.reduce((y,g)=>y+g.amountMinor,0);c.push({id:"due-soon-7-days",severity:"warning",category:"collect",title:`${v.length} payment${v.length>1?"s":""} due within 7 days`,description:"Send reminders to ensure timely payment.",impactMinor:i,impactCurrency:n.currency,relatedEventIds:v.map(y=>y.id),primaryAction:{label:"View Details",type:"viewReceivables"}})}const h=s.filter(i=>i.source==="retainer"&&(i.state==="overdue"||i.state==="missed"));if(h.length>0){const i=h.reduce((y,g)=>y+g.amountMinor,0);c.push({id:"retainer-overdue",severity:"warning",category:"collect",title:`${h.length} retainer payment${h.length>1?"s":""} overdue`,description:"Follow up on these recurring payments to maintain cash flow.",impactMinor:i,impactCurrency:n.currency,relatedEventIds:h.map(y=>y.id),primaryAction:{label:"View Retainers",type:"viewRetainers"}})}const x=s.filter(i=>i.direction==="outflow"&&i.state==="upcoming"&&i.amountMinor>d*.3);for(const i of x)c.push({id:`large-expense-${i.id}`,severity:"warning",category:"reduce",title:`Large upcoming expense: ${i.title}`,description:"This expense is significant. Ensure you have sufficient funds.",impactMinor:i.amountMinor,impactCurrency:n.currency,relatedEventIds:[i.id]});const m=s.filter(i=>i.direction==="inflow"&&i.state==="unpaid"&&!i.dueDate);m.length>0&&c.push({id:"missing-due-dates",severity:"info",category:"hygiene",title:`${m.length} receivable${m.length>1?"s":""} without due date`,description:"Add due dates to track payment timelines better.",impactMinor:m.reduce((i,y)=>i+y.amountMinor,0),impactCurrency:n.currency,relatedEventIds:m.map(i=>i.id),primaryAction:{label:"View Details",type:"viewReceivables"}});const w={critical:0,warning:1,info:2};return c.sort((i,y)=>w[i.severity]-w[y.severity]),c},async getMonthKPIs(n,t=0){if(!n.month)throw new Error("Month is required for KPIs");const s=K(),c=await this.getMoneyEvents(n);let a=t,d=0,l=0;for(const h of c){const x=h.eventDate<=s;h.direction==="inflow"?h.state==="paid"&&x?a+=h.amountMinor:(h.state==="unpaid"||h.state==="overdue"||h.state==="upcoming")&&(d+=h.amountMinor):h.state==="paid"&&x?a-=h.amountMinor:(h.state==="upcoming"||h.eventDate>s)&&(l+=h.amountMinor)}const u=a+d-l,v=d-l;return{willMakeItMinor:u,cashOnHandMinor:a,comingMinor:d,leakingMinor:l,netForecastMinor:v}},async getDayEvents(n,t){const s=n.substring(0,7);return(await this.getMoneyEvents({month:s,currency:t,includeReceivables:!0,includeProjections:!0})).filter(a=>a.eventDate===n)},getYearMonthKeys(n){return Array.from({length:12},(t,s)=>`${n}-${String(s+1).padStart(2,"0")}`)},async getYearSummary(n,t,s=!0,c=!0){const a=this.getYearMonthKeys(n),d=[];let l=0,u=0,v=0,h,x,m=-1/0,w=1/0;for(const g of a){const r=await this.getMonthSummary({month:g,currency:t,includeReceivables:s,includeProjections:c});d.push(r),l+=r.totalInflowMinor,u+=r.totalOutflowMinor,v+=r.awaitingMinor,(r.totalInflowMinor>0||r.totalOutflowMinor>0)&&(r.netMinor>m&&(m=r.netMinor,h=g),r.netMinor<w&&(w=r.netMinor,x=g))}const i=Math.round(v/12);let y=0;try{const g=`${n}-01-01`,r=`${n}-12-31`,p=await C.projectedIncome.filter(o=>o.currency!==t?!1:o.expectedDate>=g&&o.expectedDate<=r).toArray();if(p.length>0){const o=p.length,f=p.filter(j=>j.state==="received"||j.receivedAmountMinor>=j.expectedAmountMinor).length;y=Math.round(f/o*100)}}catch{}return{year:n,totalInflowMinor:l,totalOutflowMinor:u,netMinor:l-u,avgAwaitingMinor:i,retainerStabilityPercent:y,months:d,bestMonth:h,worstMonth:x}},async getYearSummaryBothCurrencies(n,t=!0,s=!0){const[c,a]=await Promise.all([this.getYearSummary(n,"USD",t,s),this.getYearSummary(n,"ILS",t,s)]);return{USD:c,ILS:a}},async getMonthKPIsBothCurrencies(n,t=0,s=0,c=!0,a=!0){const[d,l]=await Promise.all([this.getMonthKPIs({month:n,currency:"USD",includeReceivables:c,includeProjections:a},t),this.getMonthKPIs({month:n,currency:"ILS",includeReceivables:c,includeProjections:a},s)]);return{USD:d,ILS:l}}},q={events:n=>["moneyEvents",n],dailyAggregates:(n,t)=>["moneyDailyAggregates",n,t],monthSummary:n=>["moneyMonthSummary",n],monthKPIs:(n,t)=>["moneyMonthKPIs",n,t],guidance:n=>["moneyGuidance",n],dayEvents:(n,t)=>["moneyDayEvents",n,t],yearSummary:(n,t,s,c)=>["moneyYearSummary",n,t,s,c]};function _(n,t=0){return B({queryKey:q.dailyAggregates(n,t),queryFn:()=>U.getDailyAggregates(n,t),enabled:!!n.month})}function ae(n){return B({queryKey:q.guidance(n),queryFn:()=>U.generateGuidance(n),enabled:!!n.month})}function z(n,t){return B({queryKey:q.dayEvents(n,t),queryFn:()=>U.getDayEvents(n,t),enabled:!!n&&!!t})}function oe(n,t=!0,s=!0){return B({queryKey:["moneyYearSummaryBoth",n,t,s],queryFn:()=>U.getYearSummaryBothCurrencies(n,t,s),enabled:!!n})}function re(n,t=0,s=0,c=!0,a=!0){return B({queryKey:["moneyMonthKPIsBoth",n,t,s,c,a],queryFn:()=>U.getMonthKPIsBothCurrencies(n,t,s,c,a),enabled:!!n})}function ce({kpis:n}){const t=k();if(!n)return e.jsxs("div",{className:"kpi-strip",children:[e.jsx(F,{}),e.jsx(F,{}),e.jsx(F,{})]});const s=n.USD.willMakeItMinor+n.ILS.willMakeItMinor,c=n.USD.cashOnHandMinor+n.ILS.cashOnHandMinor;return e.jsxs("div",{className:"kpi-strip",children:[e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label",children:t("moneyAnswers.kpi.willMakeIt")}),e.jsx("div",{className:"kpi-card-value-unified",children:e.jsx(A,{usdAmountMinor:n.USD.willMakeItMinor,ilsAmountMinor:n.ILS.willMakeItMinor,type:s>=0?"income":"expense",size:"large"})}),e.jsx("div",{className:"kpi-card-subtitle",children:t("moneyAnswers.kpi.endOfMonthForecast")})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label",children:t("moneyAnswers.kpi.cashOnHand")}),e.jsx("div",{className:"kpi-card-value-unified",children:e.jsx(A,{usdAmountMinor:n.USD.cashOnHandMinor,ilsAmountMinor:n.ILS.cashOnHandMinor,type:c>=0?"income":"expense",size:"large"})}),e.jsx("div",{className:"kpi-card-subtitle",children:t("moneyAnswers.kpi.currentBalance")})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label",children:t("moneyAnswers.kpi.comingVsLeaking")}),e.jsxs("div",{className:"kpi-card-coming-leaking-unified",children:[e.jsxs("div",{className:"kpi-incoming-unified",children:[e.jsx(le,{}),e.jsx(A,{usdAmountMinor:n.USD.comingMinor,ilsAmountMinor:n.ILS.comingMinor,type:"income"})]}),e.jsx("span",{className:"kpi-divider",children:"/"}),e.jsxs("div",{className:"kpi-outgoing-unified",children:[e.jsx(de,{}),e.jsx(A,{usdAmountMinor:n.USD.leakingMinor,ilsAmountMinor:n.ILS.leakingMinor,type:"expense"})]})]}),e.jsxs("div",{className:"kpi-card-subtitle",children:[t("moneyAnswers.kpi.netForecast"),": "," ",e.jsx(A,{usdAmountMinor:n.USD.netForecastMinor,ilsAmountMinor:n.ILS.netForecastMinor,type:"net"})]})]})]})}function F(){return e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label skeleton",style:{width:"60%",height:"12px"}}),e.jsx("div",{className:"kpi-card-value skeleton",style:{width:"80%",height:"28px",marginTop:"8px"}}),e.jsx("div",{className:"kpi-card-subtitle skeleton",style:{width:"50%",height:"12px",marginTop:"8px"}})]})}function le(){return e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"})})}function de(){return e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m4.5 4.5 15 15m0 0V8.25m0 11.25H8.25"})})}function ue(n){return new Date(n).getDate().toString()}function me(n){const t=new Date().toISOString().split("T")[0];return n===t}function he({dailyAggregatesUSD:n,dailyAggregatesILS:t}){const s=k(),c=O(m=>m.openDayDetailDrawer),{rate:a}=R("USD","ILS"),{language:d}=H(),l=Y(d),u=D.useMemo(()=>{const m=new Map;for(const g of n)m.set(g.date,g);const w=new Map;for(const g of t)w.set(g.date,g);const i=new Set([...n.map(g=>g.date),...t.map(g=>g.date)]);return Array.from(i).sort().map(g=>{const r=m.get(g),p=w.get(g),o=b(r?.inflowMinor||0,p?.inflowMinor||0,"ILS",a)||0,f=b(r?.outflowMinor||0,p?.outflowMinor||0,"ILS",a)||0,j=b(r?.runningBalanceMinor||0,p?.runningBalanceMinor||0,"ILS",a)||0;return{date:g,inflowMinor:o,outflowMinor:f,runningBalanceMinor:j,usdInflow:r?.inflowMinor||0,usdOutflow:r?.outflowMinor||0,ilsInflow:p?.inflowMinor||0,ilsOutflow:p?.outflowMinor||0,hasEvents:(r?.events?.length||0)+(p?.events?.length||0)>0}})},[n,t,a]),v=D.useMemo(()=>{let m=0,w=0,i=0,y=0;for(const g of u)m=Math.max(m,g.inflowMinor),w=Math.max(w,g.outflowMinor),i=Math.max(i,g.runningBalanceMinor),y=Math.min(y,g.runningBalanceMinor);return{maxBar:Math.max(m,w,1),maxBalance:i,minBalance:y,balanceRange:i-y||1}},[u]),h=D.useMemo(()=>{if(u.length===0)return"";const m=[],w=100/u.length;return u.forEach((i,y)=>{const g=(y+.5)*w,p=100-((i.runningBalanceMinor-v.minBalance)/v.balanceRange*80+10);m.push(`${g},${p}`)}),`M ${m.join(" L ")}`},[u,v]);if(u.length===0)return e.jsx("div",{className:"timeline-container",children:e.jsx("div",{className:"timeline-empty",children:s("moneyAnswers.noData")})});const x=m=>{c({date:m})};return e.jsxs("div",{className:"timeline-container",children:[e.jsxs("div",{className:"timeline-chart",children:[u.map(m=>{const w=m.inflowMinor/v.maxBar*100,i=m.outflowMinor/v.maxBar*100;return e.jsxs("div",{className:`timeline-day ${me(m.date)?"today":""}`,onClick:()=>x(m.date),role:"button",tabIndex:0,onKeyDown:y=>{(y.key==="Enter"||y.key===" ")&&x(m.date)},"aria-label":`${m.date}`,children:[e.jsxs("div",{className:"timeline-bars",children:[w>0&&e.jsx("div",{className:"timeline-bar inflow",style:{height:`${Math.max(w,2)}%`},title:`+${I(m.inflowMinor,"ILS",l)} (USD: ${I(m.usdInflow,"USD",l)}, ILS: ${I(m.ilsInflow,"ILS",l)})`}),i>0&&e.jsx("div",{className:"timeline-bar outflow",style:{height:`${Math.max(i,2)}%`},title:`-${I(m.outflowMinor,"ILS",l)} (USD: ${I(m.usdOutflow,"USD",l)}, ILS: ${I(m.ilsOutflow,"ILS",l)})`}),!m.hasEvents&&e.jsx("div",{className:"timeline-bar empty",style:{height:"2px",opacity:.3}})]}),e.jsx("div",{className:"timeline-date",children:ue(m.date)})]},m.date)}),h&&e.jsx("div",{className:"timeline-balance-line",children:e.jsx("svg",{viewBox:"0 0 100 100",preserveAspectRatio:"none",children:e.jsx("path",{d:h})})})]}),e.jsxs("div",{className:"timeline-legend",children:[e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-color inflow"}),e.jsx("span",{children:s("moneyAnswers.legend.inflow")})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-color outflow"}),e.jsx("span",{children:s("moneyAnswers.legend.outflow")})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-line"}),e.jsx("span",{children:s("moneyAnswers.legend.runningBalance")})]}),e.jsx("div",{className:"legend-item unified-note",children:e.jsx("span",{children:s("moneyAnswers.unifiedNote")})})]})]})}function ye(n,t){const s=(n/100).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});return`${t} ${s}`}function pe({items:n}){const t=k();return n.length===0?e.jsx("div",{className:"guidance-feed",children:e.jsxs("div",{className:"guidance-empty",children:[e.jsx(xe,{}),e.jsx("p",{children:t("moneyAnswers.guidance.allGood")})]})}):e.jsx("div",{className:"guidance-feed",children:n.map(s=>e.jsx(ge,{item:s},s.id))})}function ge({item:n}){const t=k(),s=Q(),c=O(d=>d.openTransactionDrawer),a=()=>{if(n.primaryAction)switch(n.primaryAction.type){case"viewReceivables":s({to:"/transactions",search:{status:"unpaid"}});break;case"viewRetainers":s({to:"/retainers"});break;case"markPaid":n.primaryAction.payload?.eventId&&c({mode:"edit",transactionId:n.primaryAction.payload.eventId});break}};return e.jsxs("div",{className:`guidance-card ${n.severity}`,children:[e.jsxs("div",{className:`guidance-icon ${n.severity}`,children:[n.severity==="critical"&&e.jsx(fe,{}),n.severity==="warning"&&e.jsx(ve,{}),n.severity==="info"&&e.jsx(we,{})]}),e.jsxs("div",{className:"guidance-content",children:[e.jsxs("div",{className:"guidance-header",children:[e.jsx("span",{className:"guidance-title",children:n.title}),e.jsx("span",{className:`guidance-badge ${n.category}`,children:t(`moneyAnswers.guidance.category.${n.category}`)})]}),e.jsx("div",{className:"guidance-description",children:n.description}),e.jsxs("div",{className:"guidance-impact",children:[t("moneyAnswers.guidance.impact"),": ",ye(n.impactMinor,n.impactCurrency)]})]}),n.primaryAction&&e.jsx("div",{className:"guidance-actions",children:e.jsx("button",{type:"button",className:"guidance-action-btn",onClick:a,children:n.primaryAction.label})})]})}function fe(){return e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"})})}function ve(){return e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"})})}function we(){return e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"})})}function xe(){return e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})})}function V({yearSummaryUSD:n,yearSummaryILS:t}){const s=k();if(!n||!t)return e.jsxs("div",{className:"year-kpi-strip",children:[e.jsx(T,{}),e.jsx(T,{}),e.jsx(T,{}),e.jsx(T,{}),e.jsx(T,{})]});const c=Math.round((n.retainerStabilityPercent+t.retainerStabilityPercent)/2);return e.jsxs("div",{className:"year-kpi-strip",children:[e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label",children:s("moneyAnswers.yearMode.totalInflow")}),e.jsx("div",{className:"kpi-card-value-unified",children:e.jsx(A,{usdAmountMinor:n.totalInflowMinor,ilsAmountMinor:t.totalInflowMinor,type:"income",size:"large"})})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label",children:s("moneyAnswers.yearMode.totalOutflow")}),e.jsx("div",{className:"kpi-card-value-unified",children:e.jsx(A,{usdAmountMinor:n.totalOutflowMinor,ilsAmountMinor:t.totalOutflowMinor,type:"expense",size:"large"})})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label",children:s("moneyAnswers.yearMode.netIncome")}),e.jsx("div",{className:"kpi-card-value-unified",children:e.jsx(A,{usdAmountMinor:n.netMinor,ilsAmountMinor:t.netMinor,type:"net",size:"large"})})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label",children:s("moneyAnswers.yearMode.avgAwaiting")}),e.jsx("div",{className:"kpi-card-value-unified",children:e.jsx(A,{usdAmountMinor:n.avgAwaitingMinor,ilsAmountMinor:t.avgAwaitingMinor,type:"neutral",size:"large"})})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label",children:s("moneyAnswers.yearMode.retainerStability")}),e.jsxs("div",{className:`kpi-card-value ${c>=80?"positive":c>=50?"":"negative"}`,children:[c,"%"]})]})]})}function T(){return e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-card-label skeleton",style:{width:"60%",height:"12px"}}),e.jsx("div",{className:"kpi-card-value skeleton",style:{width:"80%",height:"28px",marginTop:"8px"}})]})}const je=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Me=["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];function Ne({monthsUSD:n,monthsILS:t,year:s,onMonthClick:c}){const a=k(),[d,l]=D.useState(null),{rate:u}=R("USD","ILS"),{language:v}=H(),h=Y(v),m=document.documentElement.dir==="rtl"?Me:je,w=D.useMemo(()=>n.map((o,f)=>{const j=t[f];return{month:o.month,totalInflowMinor:b(o.totalInflowMinor,j?.totalInflowMinor||0,"ILS",u)||0,totalOutflowMinor:b(o.totalOutflowMinor,j?.totalOutflowMinor||0,"ILS",u)||0,netMinor:b(o.netMinor,j?.netMinor||0,"ILS",u)||0,usdInflow:o.totalInflowMinor,usdOutflow:o.totalOutflowMinor,ilsInflow:j?.totalInflowMinor||0,ilsOutflow:j?.totalOutflowMinor||0}}),[n,t,u]),i=D.useMemo(()=>{let o=0;for(const f of w)o=Math.max(o,f.totalInflowMinor,f.totalOutflowMinor);return o||1},[w]),y=new Date,g=y.getFullYear(),r=y.getMonth();return w.some(o=>o.totalInflowMinor>0||o.totalOutflowMinor>0)?e.jsxs("div",{className:"monthly-trend-bars",children:[e.jsx("div",{className:"section-title",children:a("moneyAnswers.yearMode.monthlyTrend")}),e.jsx("div",{className:"trend-bars-container",children:w.map((o,f)=>{const j=o.totalInflowMinor/i*100,$=o.totalOutflowMinor/i*100,S=s===g&&f===r,L=d===f;return e.jsxs("div",{className:`trend-bar-column ${S?"current":""} ${L?"hovered":""}`,onClick:()=>c(o.month),onMouseEnter:()=>l(f),onMouseLeave:()=>l(null),children:[e.jsxs("div",{className:"trend-bar-bars",children:[e.jsx("div",{className:"trend-bar inflow",style:{height:`${Math.max(j,2)}%`}}),e.jsx("div",{className:"trend-bar outflow",style:{height:`${Math.max($,2)}%`}})]}),e.jsx("div",{className:"trend-bar-label",children:m[f]}),L&&e.jsxs("div",{className:"trend-bar-tooltip unified-tooltip",children:[e.jsxs("div",{className:"tooltip-title",children:[m[f]," ",s]}),e.jsxs("div",{className:"tooltip-section",children:[e.jsxs("div",{className:"tooltip-row inflow",children:[e.jsxs("span",{children:[a("moneyAnswers.legend.inflow"),":"]}),e.jsx("span",{children:I(o.totalInflowMinor,"ILS",h)})]}),e.jsxs("div",{className:"tooltip-breakdown",children:[e.jsxs("span",{children:["USD: ",I(o.usdInflow,"USD",h)]}),e.jsxs("span",{children:["ILS: ",I(o.ilsInflow,"ILS",h)]})]})]}),e.jsxs("div",{className:"tooltip-section",children:[e.jsxs("div",{className:"tooltip-row outflow",children:[e.jsxs("span",{children:[a("moneyAnswers.legend.outflow"),":"]}),e.jsx("span",{children:I(o.totalOutflowMinor,"ILS",h)})]}),e.jsxs("div",{className:"tooltip-breakdown",children:[e.jsxs("span",{children:["USD: ",I(o.usdOutflow,"USD",h)]}),e.jsxs("span",{children:["ILS: ",I(o.ilsOutflow,"ILS",h)]})]})]}),e.jsxs("div",{className:"tooltip-row net",children:[e.jsxs("span",{children:[a("moneyAnswers.dayDetail.net"),":"]}),e.jsxs("span",{className:o.netMinor>=0?"positive":"negative",children:[o.netMinor>=0?"+":"",I(o.netMinor,"ILS",h)]})]})]})]},o.month)})}),e.jsxs("div",{className:"trend-bars-legend",children:[e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-color inflow"}),e.jsx("span",{children:a("moneyAnswers.legend.inflow")})]}),e.jsxs("div",{className:"legend-item",children:[e.jsx("div",{className:"legend-color outflow"}),e.jsx("span",{children:a("moneyAnswers.legend.outflow")})]}),e.jsx("div",{className:"legend-item unified-note",children:e.jsx("span",{children:a("moneyAnswers.unifiedNote")})})]})]}):e.jsxs("div",{className:"monthly-trend-bars",children:[e.jsx("div",{className:"section-title",children:a("moneyAnswers.yearMode.monthlyTrend")}),e.jsx("div",{className:"trend-bars-empty",children:a("moneyAnswers.yearMode.noDataForYear")})]})}function Ie({year:n,includeReceivables:t,includeProjections:s,onMonthClick:c}){const a=k(),{data:d,isLoading:l}=oe(n,t,s);return l?e.jsxs("div",{className:"year-mode-view",children:[e.jsx(V,{yearSummaryUSD:void 0,yearSummaryILS:void 0}),e.jsx("div",{className:"year-mode-content",children:e.jsx("div",{className:"loading-state",children:e.jsx("span",{children:a("common.loading")})})})]}):e.jsxs("div",{className:"year-mode-view",children:[e.jsx(V,{yearSummaryUSD:d?.USD,yearSummaryILS:d?.ILS}),e.jsx("section",{className:"year-chart-section",children:e.jsx(Ne,{monthsUSD:d?.USD?.months||[],monthsILS:d?.ILS?.months||[],year:n,onMonthClick:c})})]})}function De(n){return new Date(n).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}function W(n,t){const s=(n/100).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});return`${t} ${s}`}function Ae({date:n,onClose:t}){const s=k(),{language:c}=H(),a=Y(c),d=O(o=>o.openTransactionDrawer),l=O(o=>o.openExpenseDrawer),{rate:u}=R("USD","ILS"),{data:v,isLoading:h}=z(n,"USD"),{data:x,isLoading:m}=z(n,"ILS"),w=h||m,i=D.useMemo(()=>[...v||[],...x||[]].sort((f,j)=>j.amountMinor-f.amountMinor),[v,x]);D.useEffect(()=>{const o=f=>{f.key==="Escape"&&t()};return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[t]);const y=i?.filter(o=>o.direction==="inflow")||[],g=i?.filter(o=>o.direction==="outflow")||[],r=D.useMemo(()=>{const o=y.filter(N=>N.currency==="USD").reduce((N,E)=>N+E.amountMinor,0),f=y.filter(N=>N.currency==="ILS").reduce((N,E)=>N+E.amountMinor,0),j=g.filter(N=>N.currency==="USD").reduce((N,E)=>N+E.amountMinor,0),$=g.filter(N=>N.currency==="ILS").reduce((N,E)=>N+E.amountMinor,0),S=b(o,f,"ILS",u)||0,L=b(j,$,"ILS",u)||0,M=S-L;return{totalInflow:S,totalOutflow:L,netChange:M}},[y,g,u]),p=o=>{o.sourceEntityType==="transaction"?(d({mode:"edit",transactionId:o.sourceEntityId}),t()):o.sourceEntityType==="expense"&&(l({mode:"edit",expenseId:o.sourceEntityId}),t())};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"day-detail-drawer-backdrop",onClick:t}),e.jsxs("div",{className:"day-detail-drawer",children:[e.jsxs("div",{className:"day-detail-header",children:[e.jsx("h2",{className:"day-detail-title",children:De(n)}),e.jsx("button",{type:"button",className:"day-detail-close",onClick:t,"aria-label":s("common.close"),children:e.jsx(be,{})})]}),e.jsxs("div",{className:"day-detail-summary",children:[e.jsxs("div",{className:"day-summary-item",children:[e.jsx("div",{className:"day-summary-label",children:s("moneyAnswers.dayDetail.inflow")}),e.jsxs("div",{className:"day-summary-value positive",children:["+",I(r.totalInflow,"ILS",a)]})]}),e.jsxs("div",{className:"day-summary-item",children:[e.jsx("div",{className:"day-summary-label",children:s("moneyAnswers.dayDetail.outflow")}),e.jsxs("div",{className:"day-summary-value negative",children:["-",I(r.totalOutflow,"ILS",a)]})]}),e.jsxs("div",{className:"day-summary-item",children:[e.jsx("div",{className:"day-summary-label",children:s("moneyAnswers.dayDetail.net")}),e.jsxs("div",{className:`day-summary-value ${r.netChange>=0?"positive":"negative"}`,children:[r.netChange>=0?"+":"",I(r.netChange,"ILS",a)]})]})]}),e.jsx("div",{className:"day-detail-events",children:w?e.jsx("div",{className:"day-events-empty",children:s("common.loading")}):i?.length===0?e.jsx("div",{className:"day-events-empty",children:s("moneyAnswers.dayDetail.noEvents")}):e.jsxs(e.Fragment,{children:[y.length>0&&e.jsxs("div",{className:"day-events-section",children:[e.jsx("div",{className:"day-events-section-title",children:s("moneyAnswers.dayDetail.inflows")}),y.map(o=>e.jsxs("div",{className:"day-event-item",onClick:()=>p(o),role:"button",tabIndex:0,onKeyDown:f=>{(f.key==="Enter"||f.key===" ")&&p(o)},children:[e.jsxs("div",{className:"day-event-info",children:[e.jsx("div",{className:"day-event-title",children:o.title}),e.jsxs("div",{className:"day-event-subtitle",children:[o.counterparty?.name||G(o.source,s),o.state!=="paid"&&e.jsxs("span",{className:"day-event-state",children:[" • ",ke(o.state,s)]})]})]}),e.jsxs("div",{className:"day-event-amount inflow",children:["+",W(o.amountMinor,o.currency)]})]},o.id))]}),g.length>0&&e.jsxs("div",{className:"day-events-section",children:[e.jsx("div",{className:"day-events-section-title",children:s("moneyAnswers.dayDetail.outflows")}),g.map(o=>e.jsxs("div",{className:"day-event-item",onClick:()=>p(o),role:"button",tabIndex:0,onKeyDown:f=>{(f.key==="Enter"||f.key===" ")&&p(o)},children:[e.jsxs("div",{className:"day-event-info",children:[e.jsx("div",{className:"day-event-title",children:o.title}),e.jsx("div",{className:"day-event-subtitle",children:o.counterparty?.name||G(o.source,s)})]}),e.jsxs("div",{className:"day-event-amount outflow",children:["-",W(o.amountMinor,o.currency)]})]},o.id))]})]})})]})]})}function G(n,t){switch(n){case"actual_income":return t("moneyAnswers.source.actualIncome");case"actual_cost":return t("moneyAnswers.source.actualCost");case"receivable":return t("moneyAnswers.source.receivable");case"profile_expense":return t("moneyAnswers.source.profileExpense");case"projected_expense":return t("moneyAnswers.source.projectedExpense");case"retainer":return t("moneyAnswers.source.retainer");default:return n}}function ke(n,t){switch(n){case"paid":return t("moneyAnswers.state.paid");case"unpaid":return t("moneyAnswers.state.unpaid");case"overdue":return t("moneyAnswers.state.overdue");case"upcoming":return t("moneyAnswers.state.upcoming");case"missed":return t("moneyAnswers.state.missed");case"cancelled":return t("moneyAnswers.state.cancelled");default:return n}}function be(){return e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18 18 6M6 6l12 12"})})}function Se(){const n=new Date;return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}function Le(){return new Date().getFullYear()}function Ee(n){const[t,s]=n.split("-").map(Number);return new Date(t,s-1,1).toLocaleDateString("en-US",{month:"long",year:"numeric"})}function Ce(n,t){const[s,c]=n.split("-").map(Number),a=new Date(s,c-1+t,1);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`}function Ke(){const n=k(),t=Q(),s=ee({from:"/money-answers"}),c=O(M=>M.dayDetailDrawer),a=O(M=>M.closeDayDetailDrawer),d=s.mode||"month",l=s.year?Number(s.year):Le(),u=D.useMemo(()=>({month:s.month||Se(),year:l,currency:"USD",includeReceivables:s.includeReceivables!==!1,includeProjections:s.includeProjections!==!1}),[s.month,s.includeReceivables,s.includeProjections,l]),v=0,h=0,{data:x,isLoading:m}=re(u.month,v,h,u.includeReceivables??!0,u.includeProjections??!0),{data:w,isLoading:i}=_({...u,currency:"USD"},v),{data:y,isLoading:g}=_({...u,currency:"ILS"},h),{data:r,isLoading:p}=ae(u),o=i||g||m||p,f=M=>{t({to:"/money-answers",search:{...s,...M},replace:!0})},j=M=>{const N=Ce(u.month,M);f({month:N})},$=M=>{f({mode:M})},S=M=>{f({year:l+M})},L=M=>{f({mode:"month",month:M})};return e.jsxs("div",{className:"money-answers-page",children:[e.jsxs("header",{className:"money-answers-header",children:[e.jsx("div",{className:"header-left",children:e.jsx("h1",{className:"page-title",children:n("moneyAnswers.title")})}),e.jsxs("div",{className:"header-controls",children:[e.jsxs("div",{className:"mode-toggle",children:[e.jsx("button",{type:"button",className:`mode-btn ${d==="month"?"active":""}`,onClick:()=>$("month"),children:n("moneyAnswers.mode.month")}),e.jsx("button",{type:"button",className:`mode-btn ${d==="year"?"active":""}`,onClick:()=>$("year"),children:n("moneyAnswers.mode.year")})]}),d==="month"?e.jsxs("div",{className:"month-navigator",children:[e.jsx("button",{type:"button",className:"month-nav-btn",onClick:()=>j(-1),"aria-label":n("common.previous"),children:e.jsx(Z,{})}),e.jsx("span",{className:"month-display",children:Ee(u.month)}),e.jsx("button",{type:"button",className:"month-nav-btn",onClick:()=>j(1),"aria-label":n("common.next"),children:e.jsx(J,{})})]}):e.jsxs("div",{className:"year-navigator",children:[e.jsx("button",{type:"button",className:"month-nav-btn",onClick:()=>S(-1),"aria-label":n("common.previous"),children:e.jsx(Z,{})}),e.jsx("span",{className:"year-display",children:l}),e.jsx("button",{type:"button",className:"month-nav-btn",onClick:()=>S(1),"aria-label":n("common.next"),children:e.jsx(J,{})})]}),e.jsxs("div",{className:"toggle-options",children:[e.jsxs("label",{className:"toggle-option",children:[e.jsx("input",{type:"checkbox",checked:u.includeReceivables,onChange:M=>f({includeReceivables:M.target.checked})}),e.jsx("span",{children:n("moneyAnswers.includeReceivables")})]}),e.jsxs("label",{className:"toggle-option",children:[e.jsx("input",{type:"checkbox",checked:u.includeProjections,onChange:M=>f({includeProjections:M.target.checked})}),e.jsx("span",{children:n("moneyAnswers.includeProjections")})]})]})]})]}),e.jsx("main",{className:"money-answers-content",children:d==="year"?e.jsx(Ie,{year:l,includeReceivables:u.includeReceivables??!0,includeProjections:u.includeProjections??!0,onMonthClick:L}):o?e.jsx("div",{className:"loading-state",children:e.jsx("span",{children:n("common.loading")})}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{kpis:x}),e.jsxs("section",{className:"timeline-section",children:[e.jsx("h2",{className:"section-title",children:n("moneyAnswers.cashFlowTimeline")}),e.jsx(he,{dailyAggregatesUSD:w||[],dailyAggregatesILS:y||[]})]}),e.jsxs("section",{className:"guidance-section",children:[e.jsx("h2",{className:"section-title",children:n("moneyAnswers.guidanceTitle")}),e.jsx(pe,{items:r||[]})]})]})}),c.isOpen&&c.date&&e.jsx(Ae,{date:c.date,onClose:a})]})}function Z(){return e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.75 19.5 8.25 12l7.5-7.5"})})}function J(){return e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m8.25 4.5 7.5 7.5-7.5 7.5"})})}export{Ke as MoneyAnswersPage};
